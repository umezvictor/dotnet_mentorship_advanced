dotnet add package Duende.IdentityServer
dotnet add package Duende.IdentityServer.AspNetIdentity


using Duende.IdentityServer.Models;
using Duende.IdentityServer;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddDbContext<AppDbContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));

builder.Services.AddIdentity<AppUser, IdentityRole>()
    .AddEntityFrameworkStores<AppDbContext>()
    .AddDefaultTokenProviders();

builder.Services.AddIdentityServer()
    .AddAspNetIdentity<AppUser>()
    .AddInMemoryIdentityResources(Config.IdentityResources)
    .AddInMemoryApiScopes(Config.ApiScopes)
    .AddInMemoryClients(Config.Clients);

builder.Services.AddAuthentication();

var app = builder.Build();

app.UseIdentityServer();

app.Run();





using Duende.IdentityServer.Models;

public static class Config
{
    public static IEnumerable<IdentityResource> IdentityResources =>
        new List<IdentityResource>
        {
            new IdentityResources.OpenId(),
            new IdentityResources.Profile(),
            new IdentityResource("roles","Your roles",new []{"role"})
        };

    public static IEnumerable<ApiScope> ApiScopes =>
        new List<ApiScope>
        {
            new ApiScope("cartapi", "Cart API")
        };

    public static IEnumerable<Client> Clients =>
        new List<Client>
        {
            new Client
            {
                ClientId = "cart-client",
                AllowedGrantTypes = GrantTypes.ResourceOwnerPassword,
                ClientSecrets = { new Secret("SuperSecret".Sha256()) },
                AllowedScopes = { "openid", "profile", "cartapi", "offline_access", "roles" },
                AllowOfflineAccess = true, // needed for refresh tokens
                AccessTokenLifetime = 3600,
                RefreshTokenUsage = TokenUsage.OneTimeOnly,
                RefreshTokenExpiration = TokenExpiration.Sliding,
                SlidingRefreshTokenLifetime = 1296000 // 15 days
            }
        };
}



Add Roles to Claims in Identity (AppUser and Identity Options)
public class AppUser : IdentityUser
{
    // Extra properties as needed
}

// In Startup or Program.cs, ensure roles are allowed in claims:
builder.Services.Configure<IdentityOptions>(options =>
{
    options.ClaimsIdentity.RoleClaimType = "role";
});





2. Securing the Cart API (.NET 8 Web API)
a. Install NuGet Packages




var builder = WebApplication.CreateBuilder(args);

builder.Services.AddAuthentication("Bearer")
    .AddJwtBearer("Bearer", options =>
    {
        options.Authority = "https://localhost:5001"; // IdentityServer URL
        options.TokenValidationParameters = new Microsoft.IdentityModel.Tokens.TokenValidationParameters
        {
            ValidateAudience = false
        };
    });

builder.Services.AddAuthorization(options =>
{
    options.AddPolicy("AdminOnly", policy => policy.RequireRole("admin"));
});

builder.Services.AddControllers();

var app = builder.Build();

app.UseAuthentication();
app.UseAuthorization();

app.MapControllers();

app.Run();




using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

[ApiController]
[Route("[controller]")]
public class CartController : ControllerBase
{
    [HttpGet]
    [Authorize] // Any authenticated user
    public IActionResult GetCart() => Ok("Your cart contents");

    [HttpPost]
    [Authorize(Roles = "admin")] // Only users with 'admin' role
    public IActionResult AddItem([FromBody] ItemDto item) => Ok("Item added");
}




a. Add Role Claims to Identity Resources


public static IEnumerable<IdentityResource> IdentityResources =>
    new List<IdentityResource>
    {
        new IdentityResources.OpenId(),
        new IdentityResources.Profile(),
        new IdentityResource("roles", "Your roles", new[] { "role" })
    };



    await userManager.AddToRoleAsync(user, "customer");
await userManager.AddToRoleAsync(user, "admin");



builder.Services.Configure<IdentityOptions>(options =>
{
    options.ClaimsIdentity.RoleClaimType = "role";
});


Update API Role-based Authorization


builder.Services.AddAuthorization(options =>
{
    options.AddPolicy("AdminOnly", policy => policy.RequireRole("admin"));
    options.AddPolicy("CustomerOnly", policy => policy.RequireRole("customer"));
    options.AddPolicy("CustomerOrAdmin", policy => policy.RequireRole("customer", "admin"));
});